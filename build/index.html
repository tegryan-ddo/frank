<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frank - Claude Code Terminal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            overflow: hidden;
            height: 100%;
            width: 100%;
        }

        /* Styled scrollbars - matches VS Code dark theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #3c3c3c;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4c4c4c;
        }

        ::-webkit-scrollbar-corner {
            background: #1e1e1e;
        }

        * {
            scrollbar-width: thin;
            scrollbar-color: #3c3c3c #1e1e1e;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #252526;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            border-bottom: 1px solid #3c3c3c;
        }

        .header h1 {
            font-size: 14px;
            font-weight: 500;
            color: #cccccc;
        }

        .tabs {
            display: flex;
            gap: 4px;
        }

        .tab {
            padding: 6px 12px;
            background: #2d2d2d;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            color: #9d9d9d;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .tab:hover {
            background: #3c3c3c;
            color: #ffffff;
        }

        .tab.active {
            background: #0e639c;
            border-color: #0e639c;
            color: #ffffff;
        }

        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .terminals-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            overflow: hidden;
        }

        .pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .pane.hidden {
            display: none;
        }

        .pane-header {
            background: #2d2d2d;
            padding: 6px 12px;
            font-size: 12px;
            color: #9d9d9d;
            border-bottom: 1px solid #3c3c3c;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pane-header .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #6a9955;
        }

        .divider-h {
            height: 4px;
            background: #3c3c3c;
            cursor: row-resize;
            flex-shrink: 0;
        }

        .divider-h:hover {
            background: #0e639c;
        }

        iframe {
            flex: 1;
            border: none;
            background: #1e1e1e;
            overflow: hidden;
        }

        /* Layout modes */
        .terminals-wrapper.split .pane { flex: 1; }
        .terminals-wrapper.claude-only .pane.bash { display: none; }
        .terminals-wrapper.claude-only .divider-h { display: none; }
        .terminals-wrapper.bash-only .pane.claude { display: none; }
        .terminals-wrapper.bash-only .divider-h { display: none; }

        /* Context Panel - always visible */
        .context-panel {
            width: 280px;
            background: #252526;
            border-left: 1px solid #3c3c3c;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-shrink: 0;
        }

        .context-panel-header {
            background: #2d2d2d;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 500;
            color: #cccccc;
            border-bottom: 1px solid #3c3c3c;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .context-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            scrollbar-width: thin;
            scrollbar-color: #3c3c3c #252526;
        }

        .context-panel-content::-webkit-scrollbar {
            display: block;
            width: 6px;
        }

        .context-panel-content::-webkit-scrollbar-track {
            background: #252526;
        }

        .context-panel-content::-webkit-scrollbar-thumb {
            background: #3c3c3c;
            border-radius: 3px;
        }

        .context-panel-content::-webkit-scrollbar-thumb:hover {
            background: #4c4c4c;
        }

        .context-section {
            margin-bottom: 16px;
        }

        .context-section-title {
            font-size: 11px;
            font-weight: 600;
            color: #9d9d9d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .context-usage-bar {
            height: 20px;
            background: #1e1e1e;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .context-usage-fill {
            height: 100%;
            background: linear-gradient(90deg, #6a9955, #4ec9b0);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            padding-left: 8px;
        }

        .context-usage-fill.warning {
            background: linear-gradient(90deg, #dcdcaa, #ce9178);
        }

        .context-usage-fill.error {
            background: linear-gradient(90deg, #f44747, #d16969);
        }

        .context-usage-text {
            font-size: 10px;
            color: #1e1e1e;
            font-weight: 600;
        }

        .context-usage-details {
            font-size: 11px;
            color: #9d9d9d;
            text-align: right;
        }

        .context-file-list {
            list-style: none;
        }

        .context-file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 8px;
            margin-bottom: 2px;
            background: #1e1e1e;
            border-radius: 4px;
            font-size: 11px;
        }

        .context-file-item:hover {
            background: #2d2d2d;
        }

        .context-file-name {
            color: #4ec9b0;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .context-tool-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 8px;
            margin-bottom: 2px;
            font-size: 11px;
        }

        .context-tool-name {
            color: #dcdcaa;
        }

        .context-tool-count {
            color: #9d9d9d;
            background: #3c3c3c;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
        }

        .context-empty {
            color: #6d6d6d;
            font-size: 11px;
            font-style: italic;
            text-align: center;
            padding: 12px;
        }

        .context-stat-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 11px;
            border-bottom: 1px solid #3c3c3c;
        }

        .context-stat-row:last-child {
            border-bottom: none;
        }

        .context-stat-label {
            color: #9d9d9d;
        }

        .context-stat-value {
            color: #cccccc;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .context-status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #6a9955;
            display: inline-block;
            margin-right: 6px;
        }

        .context-status-indicator.warning {
            background: #dcdcaa;
        }

        .context-status-indicator.error {
            background: #f44747;
        }

        .context-model-badge {
            background: #0e639c;
            color: #ffffff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
        }

        .context-panel-header-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Feedback Section */
        .feedback-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #3c3c3c;
        }

        .feedback-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .feedback-btn {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #3c3c3c;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .feedback-btn.positive {
            background: #1e3a1e;
            color: #6a9955;
        }

        .feedback-btn.positive:hover {
            background: #2d5a2d;
            border-color: #6a9955;
        }

        .feedback-btn.negative {
            background: #3a1e1e;
            color: #f44747;
        }

        .feedback-btn.negative:hover {
            background: #5a2d2d;
            border-color: #f44747;
        }

        .feedback-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .feedback-sent {
            text-align: center;
            padding: 12px;
            color: #6a9955;
            font-size: 12px;
        }

        .dashboard-link {
            display: block;
            margin-top: 16px;
            padding: 10px;
            background: #2d2d2d;
            border: 1px solid #3c3c3c;
            border-radius: 6px;
            color: #4ec9b0;
            text-decoration: none;
            text-align: center;
            font-size: 12px;
            transition: all 0.2s;
        }

        .dashboard-link:hover {
            background: #3c3c3c;
            border-color: #4ec9b0;
        }

        /* Update Available Indicator */
        .update-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            margin-left: auto;
            padding: 4px 12px;
            background: #3d3d00;
            border: 1px solid #dcdcaa;
            border-radius: 4px;
            font-size: 11px;
            color: #dcdcaa;
        }

        .update-indicator.visible {
            display: flex;
        }

        .update-indicator .update-icon {
            font-size: 14px;
        }

        .update-indicator .update-text {
            font-weight: 500;
        }

        .update-indicator .update-version {
            color: #9d9d9d;
            font-family: 'Consolas', monospace;
        }

        .restart-btn {
            padding: 4px 10px;
            background: #0e639c;
            border: none;
            border-radius: 3px;
            color: #ffffff;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .restart-btn:hover {
            background: #1177bb;
        }

        .restart-btn:disabled {
            background: #3c3c3c;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Frank</h1>
        <div class="tabs">
            <button class="tab active" data-view="split">Split View</button>
            <button class="tab" data-view="claude-only">Claude Only</button>
            <button class="tab" data-view="bash-only">Bash Only</button>
        </div>
        <div class="update-indicator" id="update-indicator">
            <span class="update-icon">&#x21bb;</span>
            <span class="update-text">Update Available</span>
            <span class="update-version" id="update-version"></span>
            <button class="restart-btn" id="restart-btn" title="Stop and restart this profile to apply the update">Restart</button>
        </div>
    </div>

    <div class="main-container">
        <!-- Terminals (stacked vertically) -->
        <div class="terminals-wrapper split" id="terminals-wrapper">
            <div class="pane claude">
                <div class="pane-header">
                    <span class="dot"></span>
                    Claude Code
                </div>
                <iframe id="claude-frame" scrolling="no"></iframe>
            </div>

            <div class="divider-h" id="divider"></div>

            <div class="pane bash">
                <div class="pane-header">
                    <span class="dot"></span>
                    Bash Terminal
                </div>
                <iframe id="bash-frame" scrolling="no"></iframe>
            </div>
        </div>

        <!-- Context Panel (always visible) -->
        <div class="context-panel" id="context-panel">
            <div class="context-panel-header">
                <div class="context-panel-header-status">
                    <span class="context-status-indicator" id="status-indicator"></span>
                    <span id="status-text">Connected</span>
                </div>
                <span class="context-model-badge" id="model-name">-</span>
            </div>
            <div class="context-panel-content">
                <!-- Context Usage Section -->
                <div class="context-section">
                    <div class="context-section-title">Context Window</div>
                    <div class="context-usage-bar">
                        <div class="context-usage-fill" id="context-usage-fill" style="width: 0%">
                            <span class="context-usage-text" id="context-usage-pct">-</span>
                        </div>
                    </div>
                    <div class="context-usage-details" id="context-usage-detail">Waiting for data...</div>
                    <div class="context-info-note" id="context-info-note" style="display: none; margin-top: 8px; padding: 8px; background: #1e1e1e; border-radius: 4px; font-size: 10px; color: #808080;">
                        Session data is stored server-side. Use /context in Claude for live stats.
                    </div>
                </div>

                <!-- Stats Section -->
                <div class="context-section">
                    <div class="context-section-title">Session Stats</div>
                    <div class="context-stat-row">
                        <span class="context-stat-label">Input Tokens</span>
                        <span class="context-stat-value" id="ctx-tokens-in">0</span>
                    </div>
                    <div class="context-stat-row">
                        <span class="context-stat-label">Output Tokens</span>
                        <span class="context-stat-value" id="ctx-tokens-out">0</span>
                    </div>
                    <div class="context-stat-row">
                        <span class="context-stat-label">Cache Read</span>
                        <span class="context-stat-value" id="ctx-cache-read">0</span>
                    </div>
                    <div class="context-stat-row">
                        <span class="context-stat-label">Cache Created</span>
                        <span class="context-stat-value" id="ctx-cache-create">0</span>
                    </div>
                    <div class="context-stat-row">
                        <span class="context-stat-label">Messages</span>
                        <span class="context-stat-value" id="ctx-messages">0</span>
                    </div>
                    <div class="context-stat-row">
                        <span class="context-stat-label">Turns</span>
                        <span class="context-stat-value" id="ctx-turns">0</span>
                    </div>
                    <div class="context-stat-row">
                        <span class="context-stat-label">Total Cost</span>
                        <span class="context-stat-value" id="ctx-cost">$0.00</span>
                    </div>
                </div>

                <!-- Tool Usage Section -->
                <div class="context-section">
                    <div class="context-section-title">Tool Usage</div>
                    <div id="tool-usage-list">
                        <div class="context-empty">No tools used yet</div>
                    </div>
                </div>

                <!-- Files Section -->
                <div class="context-section">
                    <div class="context-section-title">Files in Context</div>
                    <ul class="context-file-list" id="context-file-list">
                        <li class="context-empty">No files detected</li>
                    </ul>
                </div>

                <!-- Feedback Section -->
                <div class="feedback-section" id="feedback-section">
                    <div class="context-section-title">Rate Response</div>
                    <div class="feedback-buttons" id="feedback-buttons">
                        <button class="feedback-btn positive" data-rating="positive">
                            <span>Good</span>
                        </button>
                        <button class="feedback-btn negative" data-rating="negative">
                            <span>Bad</span>
                        </button>
                    </div>
                    <div class="feedback-sent" id="feedback-sent" style="display: none;">
                        Thanks for your feedback!
                    </div>
                </div>

                <!-- Dashboard Link -->
                <a href="/dashboard" class="dashboard-link" id="dashboard-link">
                    View Analytics Dashboard
                </a>
            </div>
        </div>
    </div>

    <script>
        // Determine terminal URLs based on access method:
        // - Via ALB (ports 80/443): use path-based routing
        //   - Default: /claude/, /bash/
        //   - Profile: /{profile}/, /{profile}/bash/
        // - Direct access (port 7680): use port-based URLs
        (function() {
            const currentPort = parseInt(window.location.port) || (window.location.protocol === 'https:' ? 443 : 80);
            const claudeFrame = document.getElementById('claude-frame');
            const bashFrame = document.getElementById('bash-frame');

            if (currentPort === 443 || currentPort === 80) {
                // Via ALB - detect path prefix from current URL
                // e.g., /enkai/ -> prefix = 'enkai'
                const pathParts = window.location.pathname.split('/').filter(Boolean);
                const pathPrefix = pathParts[0] || '';
                const base = `${window.location.protocol}//${window.location.host}`;

                // Check if this is a profile path (not a static route like /claude or /bash)
                const staticRoutes = ['claude', 'bash', 'status', 'health', 'api', 'dashboard', '_t', '_b'];
                if (pathPrefix && !staticRoutes.includes(pathPrefix)) {
                    // Profile-based routing: use subpaths for terminals to avoid iframe loops
                    // /{profile}/_t/ for Claude terminal, /{profile}/_b/ for Bash terminal
                    claudeFrame.src = `${base}/${pathPrefix}/_t/`;
                    bashFrame.src = `${base}/${pathPrefix}/_b/`;
                } else {
                    // Default service routing
                    claudeFrame.src = `${base}/claude/`;
                    bashFrame.src = `${base}/bash/`;
                }
            } else {
                // Direct access - calculate ports (web=7680, claude=7681, bash=7682)
                const claudePort = currentPort + 1;
                const bashPort = currentPort + 2;
                claudeFrame.src = `http://${window.location.hostname}:${claudePort}/`;
                bashFrame.src = `http://${window.location.hostname}:${bashPort}/`;
            }
            console.log('Claude URL:', claudeFrame.src);
            console.log('Bash URL:', bashFrame.src);
        })();

        // Storage key for preferences (shared across all instances)
        const STORAGE_KEY = 'frank-layout-prefs';

        // Load saved preferences
        function loadPreferences() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (e) {
                console.warn('Failed to load preferences:', e);
            }
            return { view: 'split', splitRatio: 50 };
        }

        // Save preferences
        function savePreferences(prefs) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(prefs));
            } catch (e) {
                console.warn('Failed to save preferences:', e);
            }
        }

        // Initialize from saved preferences
        const prefs = loadPreferences();

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                const wrapper = document.getElementById('terminals-wrapper');
                wrapper.className = 'terminals-wrapper ' + tab.dataset.view;

                // Save view preference
                prefs.view = tab.dataset.view;
                savePreferences(prefs);
            });
        });

        // Restore saved view mode
        if (prefs.view) {
            const targetTab = document.querySelector(`.tab[data-view="${prefs.view}"]`);
            if (targetTab) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                targetTab.classList.add('active');
                document.getElementById('terminals-wrapper').className = 'terminals-wrapper ' + prefs.view;
            }
        }

        // Resizable divider (horizontal)
        const divider = document.getElementById('divider');
        const wrapper = document.getElementById('terminals-wrapper');
        const claudePane = document.querySelector('.pane.claude');
        const bashPane = document.querySelector('.pane.bash');

        let isResizing = false;

        // Restore saved split ratio
        if (prefs.splitRatio && prefs.splitRatio > 20 && prefs.splitRatio < 80) {
            claudePane.style.flex = prefs.splitRatio;
            bashPane.style.flex = 100 - prefs.splitRatio;
        }

        divider.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = 'row-resize';
            document.body.style.userSelect = 'none';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;

            const wrapperRect = wrapper.getBoundingClientRect();
            const percentage = ((e.clientY - wrapperRect.top) / wrapperRect.height) * 100;

            if (percentage > 20 && percentage < 80) {
                claudePane.style.flex = percentage;
                bashPane.style.flex = 100 - percentage;
            }
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                // Save the split ratio when done resizing
                const claudeFlex = parseFloat(claudePane.style.flex) || 50;
                prefs.splitRatio = claudeFlex;
                savePreferences(prefs);
            }
            isResizing = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
        });

        // Status polling
        // Determine status URL based on access method:
        // - Via ALB (ports 80/443): use same origin with /status path (with profile prefix if applicable)
        // - Direct access (port 7680): calculate port+3 for local status server
        const statusPort = parseInt(window.location.port) || (window.location.protocol === 'https:' ? 443 : 80);
        let STATUS_URL;
        if (statusPort === 443 || statusPort === 80) {
            // Via ALB - detect profile prefix and use appropriate path
            const pathParts = window.location.pathname.split('/').filter(Boolean);
            const pathPrefix = pathParts[0] || '';
            const staticRoutes = ['claude', 'bash', 'status', 'health', 'api', 'dashboard'];

            if (pathPrefix && !staticRoutes.includes(pathPrefix)) {
                // Profile-based: /{profile}/status
                STATUS_URL = `${window.location.protocol}//${window.location.host}/${pathPrefix}/status`;
            } else {
                // Default: /status
                STATUS_URL = `${window.location.protocol}//${window.location.host}/status`;
            }
        } else {
            // Direct access - calculate status port (status server now on same port as web)
            STATUS_URL = `http://${window.location.hostname}:${statusPort}/status`;
        }
        console.log('STATUS_URL:', STATUS_URL, '(port:', statusPort, ')');

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function updateStatus(data) {
            const indicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');

            if (data.error) {
                indicator.className = 'context-status-indicator error';
                statusText.textContent = 'Error';
                return;
            }

            // Update model
            if (data.model) {
                document.getElementById('model-name').textContent = data.model;
            } else {
                document.getElementById('model-name').textContent = 'Sonnet';
            }

            // Check if Claude process is running
            if (data.connected === false) {
                indicator.className = 'context-status-indicator error';
                statusText.textContent = 'Not Running';
                updateContextPanel(data);
                return;
            }

            // Update indicator based on context usage
            if (data.context_used && data.context_max) {
                const usage = data.context_used / data.context_max;

                if (usage > 0.9) {
                    indicator.className = 'context-status-indicator error';
                    statusText.textContent = 'Context High';
                } else if (usage > 0.7) {
                    indicator.className = 'context-status-indicator warning';
                    statusText.textContent = 'Context Warning';
                } else {
                    indicator.className = 'context-status-indicator';
                    statusText.textContent = 'Connected';
                }
            } else {
                indicator.className = 'context-status-indicator';
                statusText.textContent = 'Connected';
            }

            // Update the context panel with all data
            updateContextPanel(data);
        }

        // Context Panel Update
        function updateContextPanel(data) {
            const usageFill = document.getElementById('context-usage-fill');
            const usagePct = document.getElementById('context-usage-pct');
            const usageDetail = document.getElementById('context-usage-detail');

            // Context window may not be available (data is server-side in newer Claude Code)
            const contextMax = data.context_max || 200000;
            if (data.context_used && contextMax) {
                const pct = Math.min(100, (data.context_used / contextMax) * 100);
                usageFill.style.width = pct + '%';
                usagePct.textContent = pct.toFixed(1) + '%';
                usageDetail.textContent = formatNumber(data.context_used) + ' / ' + formatNumber(contextMax) + ' tokens';

                usageFill.classList.remove('warning', 'error');
                if (pct > 90) {
                    usageFill.classList.add('error');
                } else if (pct > 70) {
                    usageFill.classList.add('warning');
                }
            } else {
                // No context data available - show as N/A
                usageFill.style.width = '0%';
                usagePct.textContent = '-';
                usageDetail.textContent = 'Data not available locally';
                usageFill.classList.remove('warning', 'error');
                // Show the info note
                const infoNote = document.getElementById('context-info-note');
                if (infoNote) infoNote.style.display = 'block';
            }

            // Update stats - show dash for unavailable data (handle 0 as valid)
            document.getElementById('ctx-tokens-in').textContent = data.tokens_in != null ? formatNumber(data.tokens_in) : '-';
            document.getElementById('ctx-tokens-out').textContent = data.tokens_out != null ? formatNumber(data.tokens_out) : '-';
            document.getElementById('ctx-cache-read').textContent = data.cache_read != null ? formatNumber(data.cache_read) : '-';
            document.getElementById('ctx-cache-create').textContent = data.cache_creation != null ? formatNumber(data.cache_creation) : '-';
            document.getElementById('ctx-messages').textContent = data.message_count != null ? data.message_count : '-';
            document.getElementById('ctx-turns').textContent = data.turn_count != null ? data.turn_count : '-';
            document.getElementById('ctx-cost').textContent = data.cost != null ? '$' + data.cost.toFixed(2) : '-';

            // Update tool usage
            const toolList = document.getElementById('tool-usage-list');
            if (data.tool_uses && Object.keys(data.tool_uses).length > 0) {
                toolList.innerHTML = Object.entries(data.tool_uses)
                    .sort((a, b) => b[1] - a[1])
                    .map(([name, count]) => `
                        <div class="context-tool-item">
                            <span class="context-tool-name">${escapeHtml(name)}</span>
                            <span class="context-tool-count">${count}</span>
                        </div>
                    `).join('');
            } else {
                toolList.innerHTML = '<div class="context-empty">No tools used yet</div>';
            }

            // Update files list
            const fileList = document.getElementById('context-file-list');
            if (data.files_in_context && data.files_in_context.length > 0) {
                fileList.innerHTML = data.files_in_context
                    .map(file => {
                        const shortPath = file.split('/').slice(-2).join('/');
                        return `
                            <li class="context-file-item">
                                <span class="context-file-name" title="${escapeHtml(file)}">${escapeHtml(shortPath)}</span>
                            </li>
                        `;
                    }).join('');
            } else {
                fileList.innerHTML = '<li class="context-empty">No files detected</li>';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function pollStatus() {
            try {
                // Use detailed endpoint for more data
                const detailedUrl = STATUS_URL.replace('/status', '/status/detailed');
                console.log('Polling:', detailedUrl);
                const response = await fetch(detailedUrl);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Status data:', data);
                    updateStatus(data);
                } else {
                    console.warn('Status response not ok:', response.status);
                }
            } catch (e) {
                console.warn('Detailed fetch failed:', e.message);
                // Fallback to basic status
                try {
                    const response = await fetch(STATUS_URL);
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Basic status data:', data);
                        updateStatus(data);
                    }
                } catch (e2) {
                    console.warn('Basic fetch failed:', e2.message);
                    // Show error state
                    updateStatus({ error: true, connected: false });
                }
            }
        }

        // Poll every 5 seconds - URL is now calculated dynamically
        console.log('Starting status polling to:', STATUS_URL);
        pollStatus();
        setInterval(pollStatus, 5000);

        // Version polling for update detection
        const updateIndicator = document.getElementById('update-indicator');
        const updateVersion = document.getElementById('update-version');
        const restartBtn = document.getElementById('restart-btn');

        async function checkForUpdates() {
            try {
                const versionUrl = STATUS_URL.replace('/status', '/status/version');
                const response = await fetch(versionUrl);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Version data:', data);

                    if (data.update_available) {
                        updateIndicator.classList.add('visible');
                        updateVersion.textContent = `v${data.current_revision} â†’ v${data.latest_revision}`;
                    } else {
                        updateIndicator.classList.remove('visible');
                    }
                }
            } catch (e) {
                console.warn('Version check failed:', e.message);
            }
        }

        // Check for updates every 5 minutes
        checkForUpdates();
        setInterval(checkForUpdates, 5 * 60 * 1000);

        // Restart button handler
        restartBtn.addEventListener('click', async () => {
            if (!confirm('This will stop the current task and start a new one with the latest version.\n\nAny unsaved work will be preserved on the shared filesystem, but your terminal session will be disconnected.\n\nContinue?')) {
                return;
            }

            restartBtn.disabled = true;
            restartBtn.textContent = 'Restarting...';

            try {
                // Get the profile name from the URL path
                const pathParts = window.location.pathname.split('/').filter(Boolean);
                const profileName = pathParts[0] || '';

                if (!profileName) {
                    alert('Could not determine profile name for restart.');
                    restartBtn.disabled = false;
                    restartBtn.textContent = 'Restart';
                    return;
                }

                // Call the API to restart the profile
                const apiUrl = `${window.location.protocol}//${window.location.host}/api/profiles/${profileName}/restart`;
                const response = await fetch(apiUrl, { method: 'POST' });

                if (response.ok) {
                    alert('Profile is restarting. Please wait a moment and then refresh the page.');
                    // Optionally auto-refresh after a delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 30000);
                } else {
                    const error = await response.text();
                    alert(`Failed to restart: ${error}`);
                    restartBtn.disabled = false;
                    restartBtn.textContent = 'Restart';
                }
            } catch (e) {
                alert(`Error: ${e.message}\n\nYou can manually restart using:\nfrank ecs stop ${window.location.pathname.split('/')[1]}\nfrank ecs start ${window.location.pathname.split('/')[1]}`);
                restartBtn.disabled = false;
                restartBtn.textContent = 'Restart';
            }
        });

        // Feedback handling
        const feedbackButtons = document.getElementById('feedback-buttons');
        const feedbackSent = document.getElementById('feedback-sent');

        document.querySelectorAll('.feedback-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const rating = btn.dataset.rating;
                const buttons = feedbackButtons.querySelectorAll('button');

                // Disable buttons
                buttons.forEach(b => b.disabled = true);

                try {
                    const feedbackUrl = STATUS_URL.replace('/status', '/status/feedback');
                    const response = await fetch(feedbackUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ rating }),
                    });

                    if (response.ok) {
                        // Show thank you message
                        feedbackButtons.style.display = 'none';
                        feedbackSent.style.display = 'block';

                        // Reset after 3 seconds
                        setTimeout(() => {
                            feedbackButtons.style.display = 'flex';
                            feedbackSent.style.display = 'none';
                            buttons.forEach(b => b.disabled = false);
                        }, 3000);
                    } else {
                        console.error('Feedback failed:', response.status);
                        buttons.forEach(b => b.disabled = false);
                    }
                } catch (e) {
                    console.error('Feedback error:', e);
                    buttons.forEach(b => b.disabled = false);
                }
            });
        });
    </script>
</body>
</html>
